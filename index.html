<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>نظام الصياد RPG مرتب</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root {
  --bg:#000; --panel:#0b0f0c; --text:#9effa1; --accent:#52ffa3;
}
body {
  margin:0; font-family:system-ui,Segoe UI,Roboto,Tahoma,Arial;
  background:var(--bg); color:var(--text);
}
header {
  padding:16px; text-align:center;
  background:linear-gradient(90deg,#071,transparent,#071);
  position:fixed; top:0; width:100%; z-index:5;
}
.container {
  padding:100px 12px 12px; max-width:980px; margin:auto;
}
.tabs {
  display:flex; gap:8px; margin-bottom:12px; overflow-x:auto;
}
.tab-btn {
  flex:1; min-width:60px; padding:10px;
  border:1px solid #104e2d; background:#08140e;
  color:var(--text); border-radius:12px; cursor:pointer;
  white-space:nowrap; text-align:center;
}
.tab-btn.active {outline:2px solid var(--accent);}
.panel {
  background:var(--panel); border-radius:14px; padding:12px; margin-bottom:12px;
}
.row {display:flex; gap:10px; flex-wrap:wrap;}
.card {background:#0f1511; border-radius:12px; padding:12px; flex:1; min-width:220px;}
.btn {
  background:#0a311b; color:var(--text); border-radius:10px;
  padding:8px 12px; cursor:pointer; margin-top:6px;
}
.btn:disabled {opacity:.5; cursor:default;}
#map {height:300px; border-radius:12px; border:1px solid #124; margin-bottom:10px;}
.footer {text-align:center; opacity:.7; font-size:12px; margin:12px 0;}
</style>
</head>
<body>
<header><h1>📜 نظام الصياد RPG مرتب</h1></header>
<div class="container">

<div class="tabs" role="tablist">
  <button class="tab-btn active" data-tab="status">⚔️ الحالة</button>
  <button class="tab-btn" data-tab="quests">🎯 المهام</button>
  <button class="tab-btn" data-tab="inventory">🎒 الجرد</button>
  <button class="tab-btn" data-tab="log">📘 النظام</button>
  <button class="tab-btn" data-tab="map">🗺️ الخريطة</button>
</div>

<section id="tab-status" class="panel">
  <div class="row">
    <div class="card">
      <h3>المستوى <span id="level">1</span></h3>
      <p>HP: <span id="hp">100</span> | MP: <span id="mp">100</span></p>
      <p>⚔️ ATK: <span id="atk">10</span> | 🛡️ DEF: <span id="def">5</span></p>
    </div>
  </div>
</section>

<section id="tab-quests" class="panel" hidden>
  <div id="questsList" class="row"></div>
</section>

<section id="tab-inventory" class="panel" hidden>
  <h3>الجرد:</h3>
  <div id="inventoryItems"></div>
</section>

<section id="tab-log" class="panel" hidden>
  <div id="log">🔔 لا توجد إشعارات بعد.</div>
</section>

<section id="tab-map" class="panel" hidden>
  <div id="map"></div>
  <button id="refreshLocationBtn" class="btn">🔄 تحديث الموقع</button>
</section>

<p class="footer">⚒ الموقع قيد التطوير – للاستفسار: 1x_x.issam.x_x5</p>
</div>

<script>
// التبويبات
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll("section[id^='tab-']").forEach(s=>s.hidden=true);
    document.getElementById("tab-"+btn.dataset.tab).hidden=false;
    if(btn.dataset.tab==="map"){ setTimeout(()=>map.invalidateSize(),200); }
  });
});

// Leaflet map
let map = L.map('map').setView([36.75, 5.83], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);

// الحالة
function updateStat(id,value){document.getElementById(id).textContent=value;}
function applyRewards(rewards){
  let hp = parseInt(document.getElementById("hp").textContent);
  let mp = parseInt(document.getElementById("mp").textContent);
  let atk = parseInt(document.getElementById("atk").textContent);
  let def = parseInt(document.getElementById("def").textContent);
  if(rewards.HP) hp+=rewards.HP;
  if(rewards.MP) mp+=rewards.MP;
  if(rewards.ATK) atk+=rewards.ATK;
  if(rewards.DEF) def+=rewards.DEF;
  updateStat("hp",hp); updateStat("mp",mp);
  updateStat("atk",atk); updateStat("def",def);
  if(rewards.items){
    const inv = document.getElementById("inventoryItems");
    rewards.items.forEach(it=>{const p=document.createElement("p");p.textContent="📦 "+it;inv.appendChild(p);});
  }
}

// المهام ديناميكية حسب الموقع
let quests = [];

function generateCityQuest(lat, lon){
  if(lat>=51.5 && lat<=51.6 && lon>=-0.2 && lon<=0){
    return {name:"اذهب إلى برج لندن", lat:51.508, lon:-0.075, desc:"برج لندن التاريخي", exp:30, rewards:{HP:5}};
  }
  if(lat>=36.75 && lat<=36.76 && lon>=5.83 && lon<=5.84){
    return {name:"اذهب إلى الحديقة العامة بسطيـف", lat:36.750, lon:5.830, desc:"الحديقة العامة بسطيـف", exp:20, rewards:{MP:10}};
  }
  return null;
}

function loadDynamicQuest(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      let cityQuest = generateCityQuest(pos.coords.latitude,pos.coords.longitude);
      if(cityQuest) quests=[cityQuest]; else quests=[];
      renderQuests();
      map.setView([pos.coords.latitude,pos.coords.longitude],15);
    }, err=>{alert("❌ لم أستطع الحصول على موقعك: "+err.message);},{enableHighAccuracy:true});
  } else alert("❌ المتصفح لا يدعم GPS");
}

// عرض المهام
function renderQuests(){
  const container=document.getElementById("questsList"); container.innerHTML="";
  quests.forEach((q,i)=>{
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<h3>${q.name}</h3>
      <p>الوصف: ${q.desc}</p>
      <p>نوع: موقع | EXP: ${q.exp}</p>
      <button id="completeBtn${i}" class="btn" disabled onclick="completeQuest(${i})">✅ إتمام المهمة</button>
      <button class="btn" onclick="startLocationTask(${i})">📍 ابدأ المهمة</button>`;
    container.appendChild(card);
  });
}

// مهام الموقع مع GPS
function startLocationTask(i){
  const q = quests[i];
  alert(`📍 انتقل إلى المكان: ${q.desc}`);
  const targetMarker = L.marker([q.lat,q.lon]).addTo(map).bindPopup(q.name).openPopup();
  let targetCircle = L.circle([q.lat,q.lon], {radius:20, color:"#1aff8c"}).addTo(map);
  map.setView([q.lat,q.lon],18);

  if(navigator.geolocation){
    const watchId = navigator.geolocation.watchPosition(pos=>{
      let userLat = pos.coords.latitude;
      let userLon = pos.coords.longitude;
      let distance = Math.sqrt(Math.pow(userLat-q.lat,2)+Math.pow(userLon-q.lon,2));
      if(distance>0.0005) targetCircle.setRadius(50);
      if(distance<0.0005){
        navigator.geolocation.clearWatch(watchId);
        document.getElementById(`completeBtn${i}`).disabled=false;
        alert("🎉 وصلت إلى المكان المطلوب! يمكنك الآن إتمام المهمة.");
        targetCircle.setRadius(20);
      }
    }, err=>{alert("❌ لم أستطع الحصول على موقعك: "+err.message);},{enableHighAccuracy:true});
  }
}

// إتمام المهمة
function completeQuest(i){
  const q=quests[i]; applyRewards(q.rewards);
  alert(`🎉 تم إتمام المهمة "${q.name}"!`);
  window.totalExp=(window.totalExp||0)+q.exp;
  let lvl=parseInt(document.getElementById("level").textContent);
  if(window.totalExp>=100){ lvl++; window.totalExp-=100; updateStat("level",lvl); alert(`🎉 ارتقيت إلى المستوى ${lvl}!`);}
}

// زر تحديث الموقع
document.getElementById("refreshLocationBtn").onclick = ()=>{
  loadDynamicQuest();
  alert("🔄 تم تحديث الموقع والمهام حسب موقعك الحالي.");
}

// تحميل المهمة عند بداية الصفحة
loadDynamicQuest();
</script>
</body>
</html>
