<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙŠØ§Ø¯ RPG - Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©</title>

<!-- MapLibre GL JS -->
<link href="https://unpkg.com/maplibre-gl@2.6.1/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@2.6.1/dist/maplibre-gl.js"></script>

<style>
:root {--bg:#000; --panel:#0b0f0c; --text:#9effa1; --accent:#52ffa3;}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Tahoma,Arial;background:var(--bg);color:var(--text);}
header{padding:16px;text-align:center;background:linear-gradient(90deg,#071,transparent,#071);position:fixed;top:0;width:100%;z-index:10;}
.container{padding:100px 12px 12px;max-width:980px;margin:auto;}
.tabs{display:flex;gap:8px;margin-bottom:12px;overflow-x:auto;}
.tab-btn{flex:1;min-width:60px;padding:10px;border:1px solid #104e2d;background:#08140e;color:var(--text);border-radius:12px;cursor:pointer;white-space:nowrap;text-align:center;}
.tab-btn.active{outline:2px solid var(--accent);}
.panel{background:var(--panel);border-radius:14px;padding:12px;margin-bottom:12px;max-height:70vh;overflow-y:auto;}
.row{display:flex;gap:10px;flex-wrap:wrap;}
.card{background:#0f1511;border-radius:12px;padding:12px;flex:1;min-width:220px;}
.btn{background:#0a311b;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer;margin-top:6px;}
.btn:disabled{opacity:.5;cursor:default;}
#map{height:300px;border-radius:12px;margin-bottom:10px;}
.footer{text-align:center;opacity:.7;font-size:12px;margin:12px 0;}
</style>
</head>
<body>

<header><h1>ğŸŒ Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙŠØ§Ø¯ RPG - Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©</h1></header>
<div class="container">

<div class="tabs" role="tablist">
  <button class="tab-btn active" data-tab="status">âš”ï¸ Ø§Ù„Ø­Ø§Ù„Ø©</button>
  <button class="tab-btn" data-tab="quests">ğŸ¯ Ø§Ù„Ù…Ù‡Ø§Ù…</button>
  <button class="tab-btn" data-tab="inventory">ğŸ’ Ø§Ù„Ø¬Ø±Ø¯</button>
  <button class="tab-btn" data-tab="log">ğŸ“˜ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
  <button class="tab-btn" data-tab="map">ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
</div>

<section id="tab-status" class="panel">
  <div class="row">
    <div class="card">
      <h3>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ <span id="level">1</span></h3>
      <p>HP: <span id="hp">100</span> | MP: <span id="mp">100</span></p>
      <p>âš”ï¸ ATK: <span id="atk">10</span> | ğŸ›¡ï¸ DEF: <span id="def">5</span></p>
    </div>
  </div>
</section>

<section id="tab-quests" class="panel" hidden>
  <div id="questsList" class="row"></div>
</section>

<section id="tab-inventory" class="panel" hidden>
  <h3>Ø§Ù„Ø¬Ø±Ø¯:</h3>
  <div id="inventoryItems"></div>
</section>

<section id="tab-log" class="panel" hidden>
  <div id="log">ğŸ”” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯.</div>
</section>

<section id="tab-map" class="panel" hidden>
  <div id="map"></div>
  <button id="refreshLocationBtn" class="btn">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
</section>

<p class="footer">âš’ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± â€“ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±: 1x_x.issam.x_x5</p>
</div>

<script>
// Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll("section[id^='tab-']").forEach(s=>s.hidden=true);
    document.getElementById("tab-"+btn.dataset.tab).hidden=false;
    if(btn.dataset.tab==="map"){ setTimeout(()=>map.resize(),200); }
  });
});

// MapLibre
let map = new maplibregl.Map({
  container: 'map',
  style: 'https://demotiles.maplibre.org/style.json',
  center: [0,0],
  zoom: 2
});
let userMarker=null;
let pathCoordinates=[];

// Ø§Ù„Ø­Ø§Ù„Ø©
function updateStat(id,value){document.getElementById(id).textContent=value;}
function applyRewards(rewards){
  let hp=parseInt(document.getElementById("hp").textContent);
  let mp=parseInt(document.getElementById("mp").textContent);
  let atk=parseInt(document.getElementById("atk").textContent);
  let def=parseInt(document.getElementById("def").textContent);
  if(rewards.HP) hp+=rewards.HP; if(rewards.MP) mp+=rewards.MP;
  if(rewards.ATK) atk+=rewards.ATK; if(rewards.DEF) def+=rewards.DEF;
  updateStat("hp",hp); updateStat("mp",mp);
  updateStat("atk",atk); updateStat("def",def);
  if(rewards.items){
    const inv=document.getElementById("inventoryItems");
    rewards.items.forEach(it=>{const p=document.createElement("p");p.textContent="ğŸ“¦ "+it;inv.appendChild(p);});
  }
}

// Ø§Ù„Ù…Ù‡Ø§Ù…
let quests=[];
const globalTasks=[
  {name:"Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©",desc:"Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù†Ø§ØµØ± Ø­ÙˆÙ„Ùƒ",exp:5,rewards:{HP:2},requiresAction:true},
  {name:"ØªÙ…Ø±ÙŠÙ† Ø§Ù„Ù‚ØªØ§Ù„",desc:"Ù‚Ù… Ø¨ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„Ù‚ØªØ§Ù„ ÙÙŠ Ù…ÙˆÙ‚Ø¹Ùƒ",exp:10,rewards:{ATK:1},requiresAction:true}
];

function loadQuestsByCity(cityName){
  let cityTasks=[];
  if(cityName=="London"){
    cityTasks.push({name:"Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø¨Ø±Ø¬ Ù„Ù†Ø¯Ù†",lat:51.508,lon:-0.075,desc:"Ø¨Ø±Ø¬ Ù„Ù†Ø¯Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ",exp:30,rewards:{HP:5},requiresAction:true});
  } else if(cityName=="Algiers"){
    cityTasks.push({name:"Ù‚Ù… Ø¨Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù‚ØµØ¨Ø©",lat:36.7538,lon:3.0588,desc:"Ø§Ù„Ù‚ØµØ¨Ø© Ø¨Ø§Ù„Ø¹Ø§ØµÙ…Ø©",exp:25,rewards:{MP:5},requiresAction:true});
  }
  quests=[...cityTasks,...globalTasks];
  quests.forEach(q=>q.actionDone=false); // ÙƒÙ„ Ù…Ù‡Ù…Ø© ØªØ¨Ø¯Ø£ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©
  renderQuests();
}

function renderQuests(){
  const container=document.getElementById("questsList"); container.innerHTML="";
  quests.forEach((q,i)=>{
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<h3>${q.name}</h3>
      <p>${q.desc||''}</p>
      <p>EXP: ${q.exp||0}</p>
      <button id="actionBtn${i}" class="btn">${q.requiresAction ? "ğŸ“ Ø§Ø¨Ø¯Ø£/Ù†ÙÙ‘Ø° Ø§Ù„ÙØ¹Ù„" : "âœ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©"}</button>
      <button id="completeBtn${i}" class="btn" disabled>âœ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©</button>`;
    container.appendChild(card);

    document.getElementById(`actionBtn${i}`).onclick=()=>{
      startLocationTask(i);
    }
    document.getElementById(`completeBtn${i}`).onclick=()=>{
      completeQuest(i);
    }
  });
}

// GPS ÙˆÙ…Ù‡Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹
function startLocationTask(i){
  const q=quests[i];
  if(!q.lat || !q.lon){ // Ù…Ù‡Ù…Ø© Ø¹Ø§Ù…Ø©
    q.actionDone=true;
    document.getElementById(`completeBtn${i}`).disabled=false;
    alert("ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©.");
    return;
  }
  map.flyTo({center:[q.lon,q.lat],zoom:15});
  new maplibregl.Marker({color:'#1aff8c'}).setLngLat([q.lon,q.lat]).setPopup(new maplibregl.Popup().setText(q.name)).addTo(map);

  if(navigator.geolocation){
    const watchId=navigator.geolocation.watchPosition(pos=>{
      const userLat=pos.coords.latitude,userLon=pos.coords.longitude;
      if(userMarker) userMarker.remove();
      userMarker=new maplibregl.Marker({color:'#ff0'}).setLngLat([userLon,userLat]).addTo(map);
      pathCoordinates.push([userLon,userLat]);

      const distanceThreshold = 0.0005;
      if(Math.abs(userLat-q.lat)<distanceThreshold && Math.abs(userLon-q.lon)<distanceThreshold){
        q.actionDone=true;
        document.getElementById(`completeBtn${i}`).disabled=true;
        alert("ğŸ‰ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨! Ø§Ø¶ØºØ· Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ 'Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©'.");
        navigator.geolocation.clearWatch(watchId);
        document.getElementById(`completeBtn${i}`).disabled=false;
      }
    },err=>{alert("âŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ: "+err.message);},{enableHighAccuracy:true});
  }
}

function completeQuest(i){
  const q=quests[i];
  if(!q.actionDone){ alert("âŒ ÙŠØ¬Ø¨ ØªÙ†ÙÙŠØ° Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹!"); return; }
  applyRewards(q.rewards);
  alert(`ğŸ‰ ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø© "${q.name}"!`);
  window.totalExp=(window.totalExp||0)+q.exp;
  let lvl=parseInt(document.getElementById("level").textContent);
  if(window.totalExp>=100){ lvl++; window.totalExp-=100; updateStat("level",lvl); alert(`ğŸ‰ Ø§Ø±ØªÙ‚ÙŠØª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${lvl}!`);}
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹
document.getElementById("refreshLocationBtn").onclick=()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      reverseGeocode(pos.coords.latitude,pos.coords.longitude);
      map.flyTo({center:[pos.coords.longitude,pos.coords.latitude],zoom:15});
    },err=>{alert("âŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ: "+err.message);},{enableHighAccuracy:true});
  }
}

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¥Ù„Ù‰ Ù…Ø¯ÙŠÙ†Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenStreetMap Nominatim API
function reverseGeocode(lat,lon){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
  .then(res=>res.json()).then(data=>{
    const city=data.address.city||data.address.town||data.address.village||data.address.county||"Unknown";
    console.log("City:",city);
    loadQuestsByCity(city);
  }).catch(err=>{ console.log(err); loadQuestsByCity("Unknown"); });
}

// ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    reverseGeocode(pos.coords.latitude,pos.coords.longitude);
    map.flyTo({center:[pos.coords.longitude,pos.coords.latitude],zoom:15});
  },err=>{alert("âŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ: "+err.message);},{enableHighAccuracy:true});
}
</script>

</body>
</html>
